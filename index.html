<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <title>4-4-4 en línea</title>
    <style type="text/css">
      #main, body, html {
        width: 100%;
      }
      .main-board, .winner-board {
        width: max(3em, 70px);
        height: max(3em, 70px);
      }
    </style>
  </head>
  <body>
    <script type="module">
      window.Game = {}
      Game.difficulty = -1
      function createGrid(cl) {
        // Create the grid container
        const gridContainer = document.createElement('div');
        gridContainer.style.display = 'grid';
        gridContainer.style.gridTemplateColumns = 'repeat(4, 1fr)';
        gridContainer.style.gridTemplateRows = 'repeat(4, 1fr)';
        gridContainer.style.gap = '5px'; // Optional: add some gap between cells
        // Iterate over rows and columns to create cells
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                // Create a cell
                const cell = document.createElement('div');
                cell.style.border = '1px solid black'; // Optional: add border to cells
                cell.style.display = 'flex';
                cell.style.alignItems = 'center';
                cell.style.justifyContent = 'center';
                cell.style.background = '#f0f0f0'; // Optional: set a background color

                // Set the cell's class to its coordinates
                cell.className = `x-${row} y-${col} ` + cl;

                // Append the cell to the grid container
                gridContainer.appendChild(cell);
            }
        }

        return gridContainer
      }
      Game.update_difficulty = function() {
        let d = document.getElementById("difficulty").value
        document.getElementById("difficulty-show").innerText = d
        Game.difficulty = parseInt(d)
      }
      Game.new_state_div = function(cl) {
        const multipleGridsContainer = document.createElement('div');
        multipleGridsContainer.style.display = 'flex';
        multipleGridsContainer.style.gap = '15px'; // Optional: add some gap 
        multipleGridsContainer.style.padding = '10px';
        multipleGridsContainer.style.width = '100%';
        multipleGridsContainer.style.justifyContent = 'center'; // Center the grids horizontally
        multipleGridsContainer.style.alignItems = 'center'; // Center the grids vertically
        multipleGridsContainer.style.flexWrap = 'wrap';
    

        for (let z = 0; z < 4; z++) {
            multipleGridsContainer.appendChild(createGrid(`z-${z} ` + cl));
        }

        return multipleGridsContainer;
      }
      Game.play_ai = function() {
        Game.interface.play_ai(Game.difficulty)
        Game.update_board()
      }
      Game.play_at = function(x, y) {
        Game.interface.play_at(x, y);
        Game.update_board()
      }
      Game.undo = function() {
        Game.interface.undo()
        Game.update_board()
      }
      Game.fillin_state = function(cl,state,buttons) {
        for (let x = 0; x < 4; x++) {
          for (let y = 0; y < 4; y++) {
            var placed_button = false;
            for (let z = 0; z < 4; z++) {
              let cell = document.querySelector(`.x-${x}.y-${y}.z-${z}` + cl)
              cell.style.color = '#000000'
              let tile = state.wasm_clone().get_at(x, y, z)
              cell.style.background = '#f0f0f0';
              if(tile === undefined) {
                cell.innerHTML = ""
                if(!placed_button && buttons) {
                  placed_button = true;
                  // Create the button element
                  const button = document.createElement('button');
                  
                  // Set the button's text content
                  button.textContent = 'J';
                  button.style.width = '100%';
                  button.style.height = '100%';

                  // Add an event listener to the button to call the alert function when clicked
                  button.addEventListener('click', function() {
                      Game.play_at(x, y)
                  });

                  // Append the button to the body or any other container
                  cell.appendChild(button);
                } else {
                }
              } else if(tile === true) {
                cell.style.background = '#493911'; // Optional: set a background 
                cell.style.color = '#ffffff'
                cell.innerHTML = "X"
              } else if(tile === false) {
                cell.style.background = '#e2d5b3'; // Optional: set a background 
                cell.innerHTML = "O"
              }
            }
          }
        }
      }
      Game.update_board = function() {
        let winner = Game.interface.winner();
        let winner_div = document.getElementById("winner");
        winner_div.innerHTML = ""
        if (winner) {
          let team = winner["0"] ? "X" : "O"
          let state = winner["1"]
          let e = document.createElement("span")
          e.innerText = `El juego terminó. Ganó ${team}`
          document.getElementById("winner").appendChild(e)
          document.getElementById("winner").appendChild(Game.new_state_div("winner-board"));
          Game.fillin_state(".winner-board",state,false)
        }
        let last = Game.interface.get_last()
        Game.fillin_state(".main-board",last,true)
      }

      import init, { Interface, State } from "./pkg/cuatro_cuatro_cuatro.js";
      Game.save = function(state) {
        const byteArray = new Uint8Array(16);

        for (let z = 0; z < 4; z++) {
          for (let y = 0; y < 4; y++) {
            for (let x = 0; x < 4; x++) {
              let bit_offset = x + (y % 2) * 4
              let byte_offset = Math.floor(y / 2) + z * 2
              let place = state.wasm_clone().get_at(x,y,z)
              if (place !== undefined) {
                byteArray[byte_offset+8] |= (place << bit_offset)
                byteArray[byte_offset] |= (1 << bit_offset)
              }

            }
          }
        }
        let binaryString = '';
        for (let i = 0; i < byteArray.length; i++) {
            binaryString += String.fromCharCode(byteArray[i]);
        }
        return btoa(unescape(encodeURIComponent(binaryString)))
      }
      Game.save_to_url = function() {
        let s = Game.save(Game.interface.get_last())
        document.getElementById('cargar').value = s
        window.location.hash = "#" + s
      }
      Game.load = function(base64) {
        console.log(base64)
        let state = new State()

        // Decode the base64 string to a binary string
        const binaryString = decodeURIComponent(escape(atob(base64)));

        // Create a byte array of the appropriate length
        const byteArray = new Uint8Array(16);

        // Convert the binary string to a byte array
        for (let i = 0; i < binaryString.length; i++) {
            byteArray[i] = binaryString.charCodeAt(i);
        }

        for (let z = 0; z < 4; z++) {
          for (let y = 0; y < 4; y++) {
            for (let x = 0; x < 4; x++) {
              let bit_offset = Math.trunc(x + (y % 2) * 4)
              let byte_offset = Math.floor(y / 2) + z * 2
              let present = (byteArray[byte_offset] & (1 << bit_offset)) != 0
              let team = (byteArray[byte_offset+8] & (1 << bit_offset)) != 0
              state = state.set_at(x,y,z,
                present ? team : undefined
              )
            }
          }
        }
        return state
      }
      Game.load_from_field = () => {
        Game.interface.push(Game.load(document.getElementById('cargar').value))
        Game.update_board()
      }
      init().then(() => {
        Game.interface = new Interface()
        document.getElementById("state").appendChild(Game.new_state_div("main-board"));
        try {
          let s = window.location.hash.slice(1)
          Game.interface.push(Game.load(s))
        } catch (e) {
          console.error(e)
        }
        Game.update_board()
      });
    </script>
    <div id="main" style="margin: auto 0 auto 0;">
      <div id="state">
      </div>
      <div id="buttons" style="display: flex; justify-content: center; align-items: center; gap: 5px">
        <button onclick="Game.play_ai()">Jugar con IA</button>
        <button onclick="Game.undo()">Deshacer</button>
        <span>Dificultad: </span>
        <span id="difficulty-show">-1</span>
        <input type="range" name="" oninput="Game.update_difficulty()" id="difficulty" min="-3" max="2">
        <button onclick="Game.save_to_url()">Guardar</button>
        <input type="text" id="cargar"/>
        <button onclick="Game.load_from_field()">Cargar</button>
      </div>
      <div id="winner" style="display: flex; justify-content: center; flex-direction: column; align-items: center; gap: 5px">
        
      </div>
    </div>
  </body>
</html>
